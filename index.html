<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ä¸­å›½èªå˜èª</title>
<style>
* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: 0 auto;
    color: #2c3e50;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    -webkit-user-select: none;
    user-select: none;
}

h1 {
    font-size: 2.5em;
    margin-bottom: 30px;
    text-align: center;
    color: #34495e;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-card {
    margin-bottom: 25px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f3f0 100%);
    color: #2c3e50;
    border-radius: 10px;
    border: 1px solid rgba(74,144,226,0.2);
    box-shadow: 0 2px 8px rgba(52,73,94,0.08);
    text-align: center;
}

.init-button {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 18px 30px;
    font-size: 1.2em;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    margin: 15px auto;
    display: block;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(231,76,60,0.4);
    transition: all 0.2s ease;
    min-height: 60px;
    min-width: 200px;
    position: relative;
    overflow: hidden;
}

.init-button:active {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(231,76,60,0.3);
}

.init-button:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
}

ul {
    list-style-type: none;
    padding: 0;
}

ul li {
    margin-bottom: 15px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f3f0 100%);
    color: #2c3e50;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(52,73,94,0.1);
    border: 1px solid rgba(74,144,226,0.1);
    transition: all 0.3s ease;
}

.word-container {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.word-number {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1em;
    flex-shrink: 0;
}

.word-info {
    flex: 1;
    min-width: 200px;
}

.chinese-text {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 5px;
    color: #2c3e50;
}

.pronunciation {
    color: #7f8c8d;
    font-size: 0.9em;
    line-height: 1.2;
}

.katakana {
    display: block;
    font-size: 0.85em;
    color: #95a5a6;
}

.pinyin {
    display: block;
    font-style: italic;
}

.play-button {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 25px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(39,174,96,0.3);
    transition: all 0.2s ease;
    min-height: 50px;
    min-width: 100px;
    position: relative;
    overflow: hidden;
}

.play-button:active {
    transform: scale(0.95);
    box-shadow: 0 2px 6px rgba(39,174,96,0.2);
}

.play-button:disabled {
    background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
    cursor: not-allowed;
    transform: none;
}

.play-button.playing {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.message {
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 500;
    text-align: center;
    display: none;
}

.error-message {
    background: #fadbd8;
    color: #c0392b;
    border: 1px solid #f1948a;
}

.success-message {
    background: #d5f4e6;
    color: #27ae60;
    border: 1px solid #82e0aa;
}

.warning-message {
    background: #fef9e7;
    color: #b7950b;
    border: 1px solid #f7dc6f;
}

#debugInfo {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 0.8em;
    z-index: 1000;
    max-width: 200px;
    display: none;
}

@media (max-width: 600px) {
    body {
        padding: 15px;
    }
    
    h1 {
        font-size: 2em;
    }
    
    .word-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .word-info {
        width: 100%;
        min-width: auto;
    }
    
    .play-button {
        width: 100%;
        padding: 18px;
        font-size: 1.2em;
    }
    
    .init-button {
        width: 100%;
        padding: 20px;
    }
}
</style>
</head>
<body>

<h1>ä¸­å›½èªå˜èªå­¦ç¿’</h1>

<div class="status-card" id="statusCard">
    <div id="initSection">
        <h3 style="margin-top: 0; color: #e74c3c;">ğŸ“± iPhone/iOSç”¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h3>
        <p>éŸ³å£°æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’<strong>å¿…ãšã‚¿ãƒƒãƒ—</strong>ã—ã¦ãã ã•ã„</p>
        <button class="init-button" id="initAudioBtn">ğŸ”Š éŸ³å£°æ©Ÿèƒ½ã‚’é–‹å§‹</button>
        <div class="message warning-message" id="initWarning">
            éŸ³å£°æ©Ÿèƒ½ã®åˆæœŸåŒ–ä¸­ã§ã™...
        </div>
    </div>
    
    <div id="readySection" style="display: none;">
        <h3 style="margin-top: 0; color: #27ae60;">âœ… æº–å‚™å®Œäº†</h3>
        <p>å„å˜èªã®å†ç”Ÿãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦éŸ³å£°ã‚’èãã“ã¨ãŒã§ãã¾ã™</p>
    </div>
</div>

<ul id="wordsList"></ul>

<div id="debugInfo"></div>

<script>
const words = [
  {"chinese" : "ä½ å¥½" , "pinyin" : "nÇ hÇo" , "katakana" : "ãƒ‹ãƒ¼ãƒã‚ª" },
  {"chinese" : "è°¢è°¢" , "pinyin" : "xiÃ¨ xie" , "katakana" : "ã‚·ã‚¨ã‚·ã‚¨" },
  {"chinese" : "æˆ‘" , "pinyin" : "wÇ’" , "katakana" : "ã‚¦ã‚©ãƒ¼" },
  {"chinese" : "ä½ " , "pinyin" : "nÇ" , "katakana" : "ãƒ‹ãƒ¼" },
  {"chinese" : "å¥½" , "pinyin" : "hÇo" , "katakana" : "ãƒã‚ª" },
  {"chinese" : "æ˜¯" , "pinyin" : "shÃ¬" , "katakana" : "ã‚·ãƒ¼" },
  {"chinese" : "ä¸" , "pinyin" : "bÃ¹" , "katakana" : "ãƒ–ãƒ¼" },
  {"chinese" : "ä¸­å›½" , "pinyin" : "zhÅng guÃ³" , "katakana" : "ã‚¸ãƒ§ãƒ³ã‚°ã‚ª" },
  {"chinese" : "æ—¥æœ¬" , "pinyin" : "rÃ¬ bÄ›n" , "katakana" : "ãƒªãƒ¼ãƒ™ãƒ³" },
  {"chinese" : "åå­—" , "pinyin" : "mÃ­ng zi" , "katakana" : "ãƒŸãƒ³ã‚ºãƒ¼" }
];

let audioInitialized = false;
let currentUtterance = null;
let debugMode = false;

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
function showDebug(message) {
    if (debugMode) {
        const debugDiv = document.getElementById('debugInfo');
        debugDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        debugDiv.style.display = 'block';
        console.log('Debug:', message);
    }
}

// éŸ³å£°æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ
function testSpeechSynthesis() {
    return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) {
            resolve(false);
            return;
        }
        
        try {
            const testUtterance = new SpeechSynthesisUtterance('');
            testUtterance.volume = 0;
            testUtterance.rate = 1;
            testUtterance.onend = () => resolve(true);
            testUtterance.onerror = () => resolve(false);
            
            speechSynthesis.speak(testUtterance);
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
            setTimeout(() => resolve(true), 1000);
        } catch (error) {
            showDebug('Speech test error: ' + error.message);
            resolve(false);
        }
    });
}

// éŸ³å£°åˆæœŸåŒ–é–¢æ•°
async function initializeAudio() {
    const initBtn = document.getElementById('initAudioBtn');
    const initWarning = document.getElementById('initWarning');
    const initSection = document.getElementById('initSection');
    const readySection = document.getElementById('readySection');
    
    initBtn.disabled = true;
    initBtn.textContent = 'åˆæœŸåŒ–ä¸­...';
    initWarning.style.display = 'block';
    
    showDebug('Starting audio initialization');
    
    try {
        // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã«ã‚ˆã‚‹ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
        if (window.AudioContext || window.webkitAudioContext) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
                showDebug('AudioContext resumed');
            }
            
            // ç„¡éŸ³å†ç”Ÿã§iOSã®åˆ¶é™ã‚’è§£é™¤
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
            
            showDebug('Silent audio played');
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—2: éŸ³å£°åˆæˆãƒ†ã‚¹ãƒˆ
        const speechWorks = await testSpeechSynthesis();
        showDebug('Speech synthesis test: ' + speechWorks);
        
        if (!speechWorks) {
            throw new Error('Speech synthesis not available');
        }
        
        // ã‚¹ãƒ†ãƒƒãƒ—3: å®Ÿéš›ã®éŸ³å£°ãƒ†ã‚¹ãƒˆ
        await new Promise((resolve, reject) => {
            const testUtterance = new SpeechSynthesisUtterance('æµ‹è¯•');
            testUtterance.lang = 'zh-CN';
            testUtterance.volume = 0.1;
            testUtterance.rate = 1;
            
            const timeout = setTimeout(() => {
                speechSynthesis.cancel();
                resolve(); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¦ã‚‚æˆåŠŸã¨ã¿ãªã™
            }, 3000);
            
            testUtterance.onend = () => {
                clearTimeout(timeout);
                showDebug('Test speech completed');
                resolve();
            };
            
            testUtterance.onerror = (event) => {
                clearTimeout(timeout);
                showDebug('Test speech error: ' + event.error);
                reject(new Error('Speech test failed: ' + event.error));
            };
            
            speechSynthesis.speak(testUtterance);
            showDebug('Test speech started');
        });
        
        // æˆåŠŸ
        audioInitialized = true;
        initSection.style.display = 'none';
        readySection.style.display = 'block';
        showDebug('Audio initialization successful');
        
    } catch (error) {
        showDebug('Initialization error: ' + error.message);
        initBtn.disabled = false;
        initBtn.textContent = 'å†è©¦è¡Œ';
        initWarning.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message + ' - å†è©¦è¡Œã—ã¦ãã ã•ã„';
        initWarning.className = 'message error-message';
    }
}

// ä¸­å›½èªã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
function playChinese(text, button, messageDiv) {
    if (!audioInitialized) {
        showMessage(messageDiv, 'å…ˆã«éŸ³å£°æ©Ÿèƒ½ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
        return;
    }
    
    if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
    }
    
    button.disabled = true;
    button.className = 'play-button playing';
    button.textContent = 'å†ç”Ÿä¸­...';
    
    showDebug('Starting speech: ' + text);
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 0.8;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // åˆ©ç”¨å¯èƒ½ãªéŸ³å£°ã‚’å–å¾—
    const voices = speechSynthesis.getVoices();
    const chineseVoice = voices.find(voice => 
        voice.lang.includes('zh') || 
        voice.name.toLowerCase().includes('chinese') ||
        voice.name.toLowerCase().includes('mandarin')
    );
    
    if (chineseVoice) {
        utterance.voice = chineseVoice;
        showDebug('Using voice: ' + chineseVoice.name);
    } else {
        showDebug('No Chinese voice found, using default');
    }
    
    utterance.onstart = () => {
        showDebug('Speech started');
        showMessage(messageDiv, 'å†ç”Ÿä¸­...', 'success');
    };
    
    utterance.onend = () => {
        showDebug('Speech ended');
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = 'ğŸ”Š å†ç”Ÿ';
        showMessage(messageDiv, 'å†ç”Ÿå®Œäº†', 'success');
        currentUtterance = null;
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 2000);
    };
    
    utterance.onerror = (event) => {
        showDebug('Speech error: ' + event.error);
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = 'ğŸ”Š å†ç”Ÿ';
        showMessage(messageDiv, 'ã‚¨ãƒ©ãƒ¼: ' + event.error, 'error');
        currentUtterance = null;
    };
    
    currentUtterance = utterance;
    
    try {
        speechSynthesis.speak(utterance);
    } catch (error) {
        showDebug('Speech exception: ' + error.message);
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = 'ğŸ”Š å†ç”Ÿ';
        showMessage(messageDiv, 'ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        currentUtterance = null;
    }
}

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
function showMessage(messageDiv, text, type) {
    messageDiv.textContent = text;
    messageDiv.className = 'message ' + type + '-message';
    messageDiv.style.display = 'block';
}

// å˜èªãƒªã‚¹ãƒˆã‚’ä½œæˆ
function createWordList() {
    const list = document.getElementById('wordsList');
    list.innerHTML = '';
    
    words.forEach((word, index) => {
        const item = document.createElement('li');
        item.innerHTML = `
            <div class="word-container">
                <div class="word-number">${index + 1}</div>
                <div class="word-info">
                    <div class="chinese-text">${word.chinese}</div>
                    <div class="pronunciation">
                        <span class="katakana">${word.katakana}</span>
                        <span class="pinyin">${word.pinyin}</span>
                    </div>
                </div>
                <button class="play-button" id="btn-${index}">ğŸ”Š å†ç”Ÿ</button>
            </div>
            <div class="message" id="msg-${index}"></div>
        `;
        
        const button = item.querySelector(`#btn-${index}`);
        const messageDiv = item.querySelector(`#msg-${index}`);
        
        button.addEventListener('click', (e) => {
            e.preventDefault();
            playChinese(word.chinese, button, messageDiv);
        });
        
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆã‚‚è¿½åŠ 
        button.addEventListener('touchend', (e) => {
            e.preventDefault();
            playChinese(word.chinese, button, messageDiv);
        });
        
        list.appendChild(item);
    });
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
document.getElementById('initAudioBtn').addEventListener('click', initializeAudio);

// éŸ³å£°ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒªã‚¹ãƒˆä½œæˆ
if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = createWordList;
}

// åˆæœŸãƒªã‚¹ãƒˆä½œæˆ
createWordList();

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼ˆç”»é¢ã‚’3å›ã‚¿ãƒƒãƒ—ï¼‰
let tapCount = 0;
document.addEventListener('click', () => {
    tapCount++;
    if (tapCount === 3) {
        debugMode = !debugMode;
        document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
        if (debugMode) showDebug('Debug mode enabled');
        tapCount = 0;
    }
    setTimeout(() => tapCount = 0, 1000);
});

// ãƒšãƒ¼ã‚¸ãŒéš ã‚ŒãŸæ™‚ã«éŸ³å£°åœæ­¢
document.addEventListener('visibilitychange', () => {
    if (document.hidden && currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
    }
});

showDebug('Script loaded');
</script>
</body>
</html>
