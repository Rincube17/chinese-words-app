<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>中国語単語</title>
<style>
* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: 0 auto;
    color: #2c3e50;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    -webkit-user-select: none;
    user-select: none;
}

h1 {
    font-size: 2.5em;
    margin-bottom: 30px;
    text-align: center;
    color: #34495e;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-card {
    margin-bottom: 25px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f3f0 100%);
    color: #2c3e50;
    border-radius: 10px;
    border: 1px solid rgba(74,144,226,0.2);
    box-shadow: 0 2px 8px rgba(52,73,94,0.08);
    text-align: center;
}

.init-button {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 18px 30px;
    font-size: 1.2em;
    font-weight: bold;
    border: none;
    border-radius: 12px;
    margin: 15px auto;
    display: block;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(231,76,60,0.4);
    transition: all 0.2s ease;
    min-height: 60px;
    min-width: 200px;
    position: relative;
    overflow: hidden;
}

.init-button:active {
    transform: scale(0.98);
    box-shadow: 0 2px 8px rgba(231,76,60,0.3);
}

.init-button:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
}

ul {
    list-style-type: none;
    padding: 0;
}

ul li {
    margin-bottom: 15px;
    padding: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #f5f3f0 100%);
    color: #2c3e50;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(52,73,94,0.1);
    border: 1px solid rgba(74,144,226,0.1);
    transition: all 0.3s ease;
}

.word-container {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.word-number {
    background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1em;
    flex-shrink: 0;
}

.word-info {
    flex: 1;
    min-width: 200px;
}

.chinese-text {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 5px;
    color: #2c3e50;
}

.pronunciation {
    color: #7f8c8d;
    font-size: 0.9em;
    line-height: 1.2;
}

.katakana {
    display: block;
    font-size: 0.85em;
    color: #95a5a6;
}

.pinyin {
    display: block;
    font-style: italic;
}

.play-button {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px 25px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 3px 12px rgba(39,174,96,0.3);
    transition: all 0.2s ease;
    min-height: 50px;
    min-width: 100px;
    position: relative;
    overflow: hidden;
}

.play-button:active {
    transform: scale(0.95);
    box-shadow: 0 2px 6px rgba(39,174,96,0.2);
}

.play-button:disabled {
    background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%);
    cursor: not-allowed;
    transform: none;
}

.play-button.playing {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.message {
    margin-top: 10px;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.9em;
    font-weight: 500;
    text-align: center;
    display: none;
}

.error-message {
    background: #fadbd8;
    color: #c0392b;
    border: 1px solid #f1948a;
}

.success-message {
    background: #d5f4e6;
    color: #27ae60;
    border: 1px solid #82e0aa;
}

.warning-message {
    background: #fef9e7;
    color: #b7950b;
    border: 1px solid #f7dc6f;
}

#debugInfo {
    position: fixed;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 10px;
    border-radius: 5px;
    font-size: 0.8em;
    z-index: 1000;
    max-width: 200px;
    display: none;
}

@media (max-width: 600px) {
    body {
        padding: 15px;
    }
    
    h1 {
        font-size: 2em;
    }
    
    .word-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .word-info {
        width: 100%;
        min-width: auto;
    }
    
    .play-button {
        width: 100%;
        padding: 18px;
        font-size: 1.2em;
    }
    
    .init-button {
        width: 100%;
        padding: 20px;
    }
}
</style>
</head>
<body>

<h1>中国語単語学習</h1>

<div class="status-card" id="statusCard">
    <div id="initSection">
        <h3 style="margin-top: 0; color: #e74c3c;">📱 iPhone/iOS用セットアップ</h3>
        <p>音声機能を有効にするため、下のボタンを<strong>必ずタップ</strong>してください</p>
        <button class="init-button" id="initAudioBtn">🔊 音声機能を開始</button>
        <div class="message warning-message" id="initWarning">
            音声機能の初期化中です...
        </div>
    </div>
    
    <div id="readySection" style="display: none;">
        <h3 style="margin-top: 0; color: #27ae60;">✅ 準備完了</h3>
        <p>各単語の再生ボタンをタップして音声を聞くことができます</p>
    </div>
</div>

<ul id="wordsList"></ul>

<div id="debugInfo"></div>

<script>
const words = [
  {"chinese" : "你好" , "pinyin" : "nǐ hǎo" , "katakana" : "ニーハオ" },
  {"chinese" : "谢谢" , "pinyin" : "xiè xie" , "katakana" : "シエシエ" },
  {"chinese" : "我" , "pinyin" : "wǒ" , "katakana" : "ウォー" },
  {"chinese" : "你" , "pinyin" : "nǐ" , "katakana" : "ニー" },
  {"chinese" : "好" , "pinyin" : "hǎo" , "katakana" : "ハオ" },
  {"chinese" : "是" , "pinyin" : "shì" , "katakana" : "シー" },
  {"chinese" : "不" , "pinyin" : "bù" , "katakana" : "ブー" },
  {"chinese" : "中国" , "pinyin" : "zhōng guó" , "katakana" : "ジョングオ" },
  {"chinese" : "日本" , "pinyin" : "rì běn" , "katakana" : "リーベン" },
  {"chinese" : "名字" , "pinyin" : "míng zi" , "katakana" : "ミンズー" }
];

let audioInitialized = false;
let currentUtterance = null;
let debugMode = false;

// デバッグ情報表示
function showDebug(message) {
    if (debugMode) {
        const debugDiv = document.getElementById('debugInfo');
        debugDiv.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
        debugDiv.style.display = 'block';
        console.log('Debug:', message);
    }
}

// 音声機能をテスト
function testSpeechSynthesis() {
    return new Promise((resolve) => {
        if (!('speechSynthesis' in window)) {
            resolve(false);
            return;
        }
        
        try {
            const testUtterance = new SpeechSynthesisUtterance('');
            testUtterance.volume = 0;
            testUtterance.rate = 1;
            testUtterance.onend = () => resolve(true);
            testUtterance.onerror = () => resolve(false);
            
            speechSynthesis.speak(testUtterance);
            
            // タイムアウト設定
            setTimeout(() => resolve(true), 1000);
        } catch (error) {
            showDebug('Speech test error: ' + error.message);
            resolve(false);
        }
    });
}

// 音声初期化関数
async function initializeAudio() {
    const initBtn = document.getElementById('initAudioBtn');
    const initWarning = document.getElementById('initWarning');
    const initSection = document.getElementById('initSection');
    const readySection = document.getElementById('readySection');
    
    initBtn.disabled = true;
    initBtn.textContent = '初期化中...';
    initWarning.style.display = 'block';
    
    showDebug('Starting audio initialization');
    
    try {
        // ステップ1: ユーザー操作によるオーディオコンテキスト作成
        if (window.AudioContext || window.webkitAudioContext) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
                showDebug('AudioContext resumed');
            }
            
            // 無音再生でiOSの制限を解除
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
            
            showDebug('Silent audio played');
        }
        
        // ステップ2: 音声合成テスト
        const speechWorks = await testSpeechSynthesis();
        showDebug('Speech synthesis test: ' + speechWorks);
        
        if (!speechWorks) {
            throw new Error('Speech synthesis not available');
        }
        
        // ステップ3: 実際の音声テスト
        await new Promise((resolve, reject) => {
            const testUtterance = new SpeechSynthesisUtterance('测试');
            testUtterance.lang = 'zh-CN';
            testUtterance.volume = 0.1;
            testUtterance.rate = 1;
            
            const timeout = setTimeout(() => {
                speechSynthesis.cancel();
                resolve(); // タイムアウトしても成功とみなす
            }, 3000);
            
            testUtterance.onend = () => {
                clearTimeout(timeout);
                showDebug('Test speech completed');
                resolve();
            };
            
            testUtterance.onerror = (event) => {
                clearTimeout(timeout);
                showDebug('Test speech error: ' + event.error);
                reject(new Error('Speech test failed: ' + event.error));
            };
            
            speechSynthesis.speak(testUtterance);
            showDebug('Test speech started');
        });
        
        // 成功
        audioInitialized = true;
        initSection.style.display = 'none';
        readySection.style.display = 'block';
        showDebug('Audio initialization successful');
        
    } catch (error) {
        showDebug('Initialization error: ' + error.message);
        initBtn.disabled = false;
        initBtn.textContent = '再試行';
        initWarning.textContent = 'エラー: ' + error.message + ' - 再試行してください';
        initWarning.className = 'message error-message';
    }
}

// 中国語を再生する関数
function playChinese(text, button, messageDiv) {
    if (!audioInitialized) {
        showMessage(messageDiv, '先に音声機能を初期化してください', 'error');
        return;
    }
    
    if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
    }
    
    button.disabled = true;
    button.className = 'play-button playing';
    button.textContent = '再生中...';
    
    showDebug('Starting speech: ' + text);
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 0.8;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    // 利用可能な音声を取得
    const voices = speechSynthesis.getVoices();
    const chineseVoice = voices.find(voice => 
        voice.lang.includes('zh') || 
        voice.name.toLowerCase().includes('chinese') ||
        voice.name.toLowerCase().includes('mandarin')
    );
    
    if (chineseVoice) {
        utterance.voice = chineseVoice;
        showDebug('Using voice: ' + chineseVoice.name);
    } else {
        showDebug('No Chinese voice found, using default');
    }
    
    utterance.onstart = () => {
        showDebug('Speech started');
        showMessage(messageDiv, '再生中...', 'success');
    };
    
    utterance.onend = () => {
        showDebug('Speech ended');
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = '🔊 再生';
        showMessage(messageDiv, '再生完了', 'success');
        currentUtterance = null;
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 2000);
    };
    
    utterance.onerror = (event) => {
        showDebug('Speech error: ' + event.error);
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = '🔊 再生';
        showMessage(messageDiv, 'エラー: ' + event.error, 'error');
        currentUtterance = null;
    };
    
    currentUtterance = utterance;
    
    try {
        speechSynthesis.speak(utterance);
    } catch (error) {
        showDebug('Speech exception: ' + error.message);
        button.disabled = false;
        button.className = 'play-button';
        button.textContent = '🔊 再生';
        showMessage(messageDiv, 'エラー: ' + error.message, 'error');
        currentUtterance = null;
    }
}

// メッセージ表示関数
function showMessage(messageDiv, text, type) {
    messageDiv.textContent = text;
    messageDiv.className = 'message ' + type + '-message';
    messageDiv.style.display = 'block';
}

// 単語リストを作成
function createWordList() {
    const list = document.getElementById('wordsList');
    list.innerHTML = '';
    
    words.forEach((word, index) => {
        const item = document.createElement('li');
        item.innerHTML = `
            <div class="word-container">
                <div class="word-number">${index + 1}</div>
                <div class="word-info">
                    <div class="chinese-text">${word.chinese}</div>
                    <div class="pronunciation">
                        <span class="katakana">${word.katakana}</span>
                        <span class="pinyin">${word.pinyin}</span>
                    </div>
                </div>
                <button class="play-button" id="btn-${index}">🔊 再生</button>
            </div>
            <div class="message" id="msg-${index}"></div>
        `;
        
        const button = item.querySelector(`#btn-${index}`);
        const messageDiv = item.querySelector(`#msg-${index}`);
        
        button.addEventListener('click', (e) => {
            e.preventDefault();
            playChinese(word.chinese, button, messageDiv);
        });
        
        // タッチイベントも追加
        button.addEventListener('touchend', (e) => {
            e.preventDefault();
            playChinese(word.chinese, button, messageDiv);
        });
        
        list.appendChild(item);
    });
}

// イベントリスナー設定
document.getElementById('initAudioBtn').addEventListener('click', initializeAudio);

// 音声リスト読み込み完了時にリスト作成
if ('speechSynthesis' in window) {
    speechSynthesis.onvoiceschanged = createWordList;
}

// 初期リスト作成
createWordList();

// デバッグモード切り替え（画面を3回タップ）
let tapCount = 0;
document.addEventListener('click', () => {
    tapCount++;
    if (tapCount === 3) {
        debugMode = !debugMode;
        document.getElementById('debugInfo').style.display = debugMode ? 'block' : 'none';
        if (debugMode) showDebug('Debug mode enabled');
        tapCount = 0;
    }
    setTimeout(() => tapCount = 0, 1000);
});

// ページが隠れた時に音声停止
document.addEventListener('visibilitychange', () => {
    if (document.hidden && currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
    }
});

showDebug('Script loaded');
</script>
</body>
</html>
